@model IEnumerable<Product>

@{
    ViewData["Title"] = "Home Page";
}

<div class="container-xxl flex-grow-1 container-p-y">
    <div class="container py-4">
        <!-- TempData Error Alert -->
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fa-solid fa-circle-exclamation me-2"></i>
                <strong>Error!</strong> @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- TempData Success Alert -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fa-solid fa-circle-check me-2"></i>
                <strong>Success!</strong> @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-1">Product Management</h2>
                <p class="text-muted mb-0">Manage your products efficiently</p>
            </div>
            <a asp-controller="Home" asp-action="AddProduct" class="btn btn-primary shadow-sm">
                <i class="fa-solid fa-plus me-2"></i>Add Product
            </a>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 fw-semibold">
                            <i class="fa-solid fa-box me-2 text-primary"></i>Products List
                        </h5>
                    </div>
                    @functions {
                        public string Capitalize(string input)
                        {
                            if (string.IsNullOrEmpty(input))
                                return input;
                            return char.ToUpper(input[0]) + input.Substring(1).ToLower();
                        }
                    }
                    <div class="card-body">
                        @if (Model != null && Model.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover datatable align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center" style="width: 5%;">No.</th>
                                            <th style="width: 20%;">Product Name</th>
                                            <th style="width: 20%;">Description</th>
                                            <th style="width: 10%;">Price</th>
                                            <th class="text-center" style="width: 5%;">Quantity</th>
                                            <th style="width: 20%;">Created At</th>
                                            <th class="text-center" style="width: 20%;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model)
                                        {
                                            <tr>
                                                <td class="text-center"></td>
                                                <td class="fw-semibold">@item.Name</td>
                                                <td class="fw-semibold text-truncate">
                                                    @(
                                                        !string.IsNullOrEmpty(item.Description) && item.Description.Length > 40
                                                        ? item.Description.Substring(0, 40) + "..."
                                                        : item.Description
                                                    )
                                                </td>
                                                <td>
                                                    <span class="badge bg-success-subtle text-success fs-6">$@item.Price.ToString("N2")</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-info-subtle text-info">@item.Quantity</span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        <i class="fa-solid fa-calendar-days me-1"></i>
                                                        @item.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")
                                                    </small>
                                                </td>
                                                <td>
                                                    <div class="d-flex gap-2 justify-content-center">
                                                        <button class="btn btn-sm btn-info view-btn" data-id="@item.ProductID" title="View Details">
                                                            <i class="fa-solid fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-primary edit-btn" data-id="@item.ProductID" title="Edit">
                                                            <i class="fa-solid fa-pen-to-square"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-danger delete-btn" data-id="@item.ProductID" title="Delete">
                                                            <i class="fa-solid fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fa-solid fa-box-open fa-4x text-muted mb-3"></i>
                                <p class="text-muted fs-5">No Products Found</p>
                                <a asp-controller="Home" asp-action="AddProduct" class="btn btn-primary mt-2">
                                    <i class="fa-solid fa-plus me-2"></i>Add Your First Product
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productDetailModalLabel">
                    <i class="fa-solid fa-box me-2"></i>Product Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-5 text-center">
                        <div class="product-image-container mb-3">
                            <img id="modalProductImage" src="" alt="Product Image" class="img-fluid rounded shadow-sm" style="max-height: 300px; object-fit: cover; width: 100%;">
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="product-details">
                            <h3 class="fw-bold mb-3" id="modalProductName"></h3>

                            <div class="detail-item mb-3">
                                <label class="text-muted small">Description</label>
                                <p class="mb-0" id="modalProductDescription"></p>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="detail-item">
                                        <label class="text-muted small">Price</label>
                                        <h4 class="text-success mb-0" id="modalProductPrice"></h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="detail-item">
                                        <label class="text-muted small">Quantity</label>
                                        <h4 class="text-info mb-0" id="modalProductQuantity"></h4>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-item mb-3">
                                <label class="text-muted small">Created At</label>
                                <p class="mb-0" id="modalProductCreatedAt"></p>
                            </div>

                            <div class="detail-item">
                                <label class="text-muted small">Last Updated</label>
                                <p class="mb-0" id="modalProductUpdatedAt"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalEditBtn">
                    <i class="fa-solid fa-pen-to-square me-2"></i>Edit Product
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(() => {
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);

            var t = $('.datatable').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                columnDefs: [{
                    searchable: false,
                    orderable: false,
                    targets: [0, 6]
                }],
                order: [5, 'ASC']
            });

            t.on('order.dt search.dt', function () {
                t.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();

             $('.datatable').on('click', '.view-btn', function() {
                var productId = $(this).data('id');

                $('#productDetailModal').modal('show');
                $('#modalProductName').text('Loading...');

                $.ajax({
                    url: '/api/product/get-product/' + productId,
                    type: 'GET',
                    success: function(product) {
                        $('#modalProductName').text(product.name);
                        $('#modalProductDescription').text(product.description || 'No description available');
                        $('#modalProductPrice').text('$' + parseFloat(product.price).toFixed(2));
                        $('#modalProductQuantity').text(product.quantity);

                        var createdDate = new Date(product.createdAt + 'Z');
                        var updatedDate = new Date(product.updatedAt + 'Z');

                        var createdLocal = createdDate.toLocaleString('en-US', {
                            month: 'short',
                            day: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });

                        var updatedLocal = updatedDate.toLocaleString('en-US', {
                            month: 'short',
                            day: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });

                        $('#modalProductCreatedAt').html('<i class="fa-solid fa-calendar-days me-1"></i>' + createdLocal);
                        $('#modalProductUpdatedAt').html('<i class="fa-solid fa-clock me-1"></i>' + updatedLocal);

                        if (product.imageUrl) {
                            $('#modalProductImage').attr('src', product.imageUrl);
                            $('#modalProductImage').attr('alt', product.name);
                        } else {
                            $('#modalProductImage').attr('src', '/uploads/shared/no-image.png');
                            $('#modalProductImage').attr('alt', 'No image available');
                        }

                        $('#modalEditBtn').data('id', productId);
                    },
                    error: function(xhr) {
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to load product details.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        $('#productDetailModal').modal('hide');
                    }
                });
            });

            $('#modalEditBtn').on('click', function() {
                var productId = $(this).data('id');
                window.location.href = '/Home/EditProduct/' + productId;
            });

            $('.datatable').on('click', '.edit-btn', function() {
                var productId = $(this).data('id');
                window.location.href = '/Home/EditProduct/' + productId;
            });

            $('.datatable').on('click', '.delete-btn', function() {
                var productId = $(this).data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/api/product/delete-product/' + productId,
                            type: 'DELETE',
                            success: function(response) {
                                Swal.fire({
                                    title: 'Deleted!',
                                    text: 'Product has been deleted.',
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    window.location.reload();
                                });
                            },
                            error: function(xhr) {
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Failed to delete product.',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                        });
                    }
                });
            });
        })
    </script>

    <style>
        .pointer-cursor {
            cursor: pointer;
        }

        .datatable tbody tr {
            transition: all 0.2s ease;
        }

            .datatable tbody tr:hover {
                background-color: #f8f9fa;
                transform: translateY(-2px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

        .btn {
            transition: all 0.2s ease;
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

        .product-image-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .detail-item label {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }
    </style>
}